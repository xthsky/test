<!doctype html>
<meta charset="gbk">
<title>New Responsive Resolution</title>
<script src="http://a.tbcdn.cn/s/kissy/1.2.0/kissy-min.js"></script>
<script>
// 如何处理页面闪的问题?
// 1. release   布局工具给每个区块分配一个id，编译生成对应关系 .vw990 #div-id <=> .w180{} .w220{}
// 2. dev       无视此问题
(function (S) {
    var ids = {},
        resolution = [990, 1220, 1200, 1440, 1400, 1660, 1600],
        dev,
        ATTR = 'bx-responsive';

    function clsReplace(cls, reg, val) {
        cls = cls.split(/\s+/);

        for (var i=0; i<cls.length; ) {
            if (cls[i].match(reg)) {
                cls.splice(i, 1);
            } else {
                ++i;
            }
        }
        cls.push(val);

        return cls.join(' ');
    }

    function resizeId(id, callback) {
        var node, res;

        node = S.one('#' + id);
        res = node.attr(ATTR).split(',');
        for (i=1; i<res.length && R.pageWidth>parseInt(res[i], 10); i+=2);
        callback(parseInt(res[i-1], 10));
    }

    function resize() {
        var vw, id, i;

        vw = S.DOM.viewportWidth();
        for (i=1; i<resolution.length && vw>resolution[i]; i+=2);
        R.pageWidth = resolution[i-1];
        document.documentElement.className = clsReplace(document.documentElement.className, /w\d+/, 'w'+R.pageWidth);

        for (id in ids) {
            resizeId(id, ids[id]);
        }

        if (dev) {
            S.use('sizzle', function(S) {
                S.ready(function (S) {
                    S.all('[' + ATTR + ']').each(function(node) {
                        var res, i;

                        res = node.attr(ATTR).split(',');
                        for (i=1; i<res.length && R.pageWidth>parseInt(res[i], 10); i+=2);
                        node.attr('class', clsReplace(node.attr('class'), /w\d+/, 'w'+res[i-1]) );
                    });
                });
            });
        }

        resize.defer = null;
    }

    function R(cfg) {
        resolution = cfg.resolution || resolution;
        dev = cfg.dev;
        resize();

        S.Event.on(window, 'resize', function() {
            if (resize.defer) {
                clearTimeout(resize.defer);
            }
            resize.defer = setTimeout(resize, 80);
        });
    };
    R.listen = function(id, callback) {
        ids[id] = callback;
        resizeId(id, callback);
    };
    this.R = R;
})(KISSY);
</script>
<script>R({dev: location.search.indexOf('mode=dev') !== -1 ? true : false});</script>
<style>
    #header, #content, #footer {
        overflow: hidden;
        margin-bottom: 10px;
        *zoom: 1;
    }
    #search, #sidebar, #main {
        float: left;
        height: 100px;
    }
    #nav, #property { height: 50px; }
    #search, #sidebar { background: #bbb; }
    #property, #footer { background: #ccc; }
    #nav, #main { background: #ddd; }
    .w0 { display: none; }
    .w190 { width: 190px; }
    .w510 { width: 510px; }
    .w990 { width: 990px; }
    .w1190 { width: 1190px; }
</style>

<div id="header">
    <div id="search" class="w190">Search</div>
    <div id="nav">Nav</div>
    <div id="property">Property Filter</div>
</div>
<div id="content">
    <div id="sidebar" class="w190">w190</div>
    <div id="main" class="w990" bx-responsive="510,990,990,1200,1190">w990</div>
</div>
<script>
    // 约定: 组件知道自己的id ?
    R.listen('main', function(width) {
        KISSY.one('#main').html('w'+width);
    });
</script>
<div id="footer">Footer</div>
